---
title: "Plant-pollintor networks worldwide are composed by the same specific building blocks"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Abstract

Ecological processes leave distinct structural imprints on indirect interactions in mutualistic networks. Detecting those relationships is not trivial since they go beyond pair-wise interactions, but may get blurred when considering full network descriptors. However, recent work has shown the network meso-scale can capture this important information. The meso-scale describes network subgraphs representing patterns of interactions between a small number of species (i.e. motifs) and those constitute the building blocks of the whole network. Here we have compiled 60 networks from 29 different studies and show that some motifs are consitently over-represented worldwide, suggesting that the building blocks of plant-pollintor networks are not random and are associated to ... Second, we show that the position of pollinator guilds and plant reproductive strategies is not random with respect to the positions occupied within each motif. ... Hence, we show that species ecology is shaping the building blocks that conform the web of life.

##INTRODUCTION

The interaction between plants and pollinators can be studied at different scales, from species level interactions (micro-scale) to the full network structure (macro-scale). However, condensing to species level and the holistic view of the full network involves missing relevant information for the understanding of ecological processes. Intermediate levels to study plant-pollinator networks (meso-scale) have been little explored but can shed light of ecological processes not captured by the traditional approaches used in plant-pollinator network studies. [Explain what macro-descriptors have found i.e. Bascompte, and what pairwise interactions descriptors have accomplished i.e. trait-matching. End explaining Benno simmons work]

Exploring the different and most frequent motifs could help our understanding of species interactions due to motifs consider direct and indirect interactions not accounted in single species metrics. [Explain this: https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2435.13736 and say we don't know how motif distribution really looks like in the real world. Which is the expected pattern?]

However, motifs are abstract representations often decoupled from species ecology. [explain here the importance of relating reproductive strategies and pollinators behaviours to their positions within a motif. This is interesting because bridges pairwise interactions to the emergent network via motifs] 

Here, we used ... blah... and fined plant functional groups by using a comprehensive dataset with several reproductive traits and pollinator functional groups as the main differentiated guilds in life form and behaviour. Then, we explored the main motifs of these networks and we found [...]

##METHODS

We have compiled 60 plant-pollinator networks from 29 different studies [...]

Plants were grouped into reproductive strategies [justify and explain the process]

Pollintors were grouped into guilds, because [justify and explain, it's important to convince the reader that Order level for pollinators and FG for plants makes sense].

We follow Simmons et al. to decompose networks on their constituent motifs. We compare observed motif frecuancies to vaznull model, which constrains the number of plants, pollinators and the network connectance. For each network we compared the observed motif frequency with the expected frecuancies and ... . To summarize general patterns across networks we used a GLMM per motif with the percentile per network, ...

Next, we calculated which functional groups were over or under-represented in different motif positions by comparing with ... . Again, we tested ...

[potential additions: 
Finally,for each motif, we recover the number of times a given combination of functional groups emerges ...
Finally, we draw a network collapsing nodes per FG...]

##RESULTS

0) Description of guilds and FG. 

1) over and under represented motifs
```{r}
library(lme4)
library(tidyverse)
source("../Scripts/Scripts_Alfonso/add_study_id.R")
d <- read_csv("../Data/Csv/Motifs_frequencies_and_null_models/Motifs_frequency_percentile.csv")
d <- add_study_id(d)
str(d)
head(d)

ggplot(d %>% filter(motif != 1), aes(percentil_sizeclass))+
  geom_histogram(color="black", fill="white")+
  facet_wrap(~motif)+
  theme_bw()+
  labs(x="Sizeclass percentile")

# Motifs tend to be over- and under-represensented in real networks

# Mean percentile and SE taking into account the study system
motif_codes <- d %>% filter(motif != 1) %>% # We remove links (motif code: 1)
  select(motif) %>% unique() %>% pull()
motif_means <- tibble(motif = motif_codes)
motif_means$mean <- NA
motif_means$SE <- NA

for(i.motif in 1:length(motif_codes)){
  
  m <- lmer(percentil_sizeclass ~ 1+(1|study_id), #HERE WE NEED STUDY SYSTEM ONLY!! 
            data = subset(d, motif == motif_codes[i.motif]))  
  
  motif_means$mean[i.motif] <- fixed.effects(m) %>% unname()
  motif_means$SE[i.motif] <- sqrt(diag(vcov(m)))
  
}


ggplot(NULL) + 
  geom_point(data = d %>% filter(motif != 1),
             aes(x=as.factor(motif), y=percentil_sizeclass, 
                 color = as.factor(motif)),
             position = "jitter",alpha=0.5)+
  geom_errorbar(data = motif_means,aes(x = as.factor(motif), ymin=mean-SE, ymax=mean+SE), 
                width=1.0,size=1)+
  geom_point(data = motif_means,aes(x = as.factor(motif), y=mean), 
                size=2)+
  labs(x="Motif", y = "Percentile")+
  theme_bw()+
  theme(legend.position = "none")

#Fig 1 Should be a dot plot (or forest plot) of the mean +- SE of the 15 motifs.
```
2) FG-position associations.
```{r}
library(lme4)
library(tidyverse)
library(stringi)
source("../Scripts/Scripts_Alfonso/add_study_id.R")

all_position_percentiles <- read_csv("../Data/Csv/Motifs_positions_and_null_models/GF_positions_frequency_percentile.csv")

all_position_percentiles$position <- stri_extract_first_regex(all_position_percentiles$position,
                                                              "[0-9]+") %>% as.numeric()

all_position_percentiles <- add_study_id(all_position_percentiles)
str(all_position_percentiles)
head(all_position_percentiles)

list_plants_FG <- as.character(1:10)

plant_position_percentiles_filtered <- all_position_percentiles %>% 
  filter(Node_FG %in% list_plants_FG, !position %in% c(1,2),
         !is.na(expected_freq_its_GF))
pollinator_position_percentiles_filtered <- all_position_percentiles %>% 
  filter(!Node_FG %in% list_plants_FG, !position %in% c(1,2),
         !is.na(expected_freq_its_GF))

ggplot(plant_position_percentiles_filtered, aes(percentil_its_GF))+
  geom_histogram(color="black", fill="white")+
  facet_wrap(~position)+
  theme_bw()+
  labs(x="Sizeclass percentile", title = "Histograms: Percentiles for plant positions")

ggplot(pollinator_position_percentiles_filtered, aes(percentil_its_GF))+
  geom_histogram(color="black", fill="white")+
  facet_wrap(~position)+
  theme_bw()+
  labs(x="Sizeclass percentile",title = "Histograms: Percentiles for pollinator positions")



# estimated mean taking into account the random str is 0.XX +- 0.XX (look at the (Intercept) estimate)


# Plants-------------

# Mean percentile and SE taking into account the study system
plant_codes <- plant_position_percentiles_filtered$position %>% unique()
plant_means <- tibble(position = plant_codes)
plant_means$mean <- NA
plant_means$SE <- NA

for(i.pos in 1:length(plant_codes)){
  
  m <- lmer(percentil_its_GF ~ 1+(1|study_id), #HERE WE NEED STUDY SYSTEM ONLY!! 
            data = subset(plant_position_percentiles_filtered,
                          position == plant_codes[i.pos]))  
  
  plant_means$mean[i.pos] <- fixed.effects(m) %>% unname()
  plant_means$SE[i.pos] <- sqrt(diag(vcov(m)))
  
}


ggplot(NULL) + 
  geom_point(data = plant_position_percentiles_filtered,
             aes(x=as.factor(position), y=percentil_its_GF, 
                 color = as.factor(position)),
             position = "jitter",alpha=0.5)+
  facet_wrap(~Node_FG)+
  geom_errorbar(data = plant_means,aes(x = as.factor(position), ymin=mean-SE, ymax=mean+SE), 
                width=1.0,size=1)+
  geom_point(data = plant_means,aes(x = as.factor(position), y=mean), 
                size=2)+
  labs(x="Position", y = "Percentile",title = "Pollinators")+
  theme_bw()+
  theme(legend.position = "none",axis.text.x=element_text(angle=90,vjust=0.5, hjust=1))



# Pollinators--------

# Mean percentile and SE taking into account the study system
pollinator_codes <- pollinator_position_percentiles_filtered$position %>% unique()
pollinator_means <- tibble(position = pollinator_codes)
pollinator_means$mean <- NA
pollinator_means$SE <- NA

for(i.pos in 1:length(pollinator_codes)){
  
  m <- lmer(percentil_its_GF ~ 1+(1|study_id), #HERE WE NEED STUDY SYSTEM ONLY!! 
            data = subset(pollinator_position_percentiles_filtered,
                          position == pollinator_codes[i.pos]))  
  
  pollinator_means$mean[i.pos] <- fixed.effects(m) %>% unname()
  pollinator_means$SE[i.pos] <- sqrt(diag(vcov(m)))
  
}


ggplot(NULL) + 
  geom_point(data = pollinator_position_percentiles_filtered,
             aes(x=as.factor(position), y=percentil_its_GF, 
                 color = as.factor(position)),
             position = "jitter",alpha=0.5)+
  facet_wrap(~Node_FG)+
  geom_errorbar(data = pollinator_means,aes(x = as.factor(position), ymin=mean-SE, ymax=mean+SE), 
                width=1.0,size=1)+
  geom_point(data = pollinator_means,aes(x = as.factor(position), y=mean), 
                size=2)+
  labs(x="Position", y = "Percentile", title = "Pollinators")+
  theme_bw()+
  theme(legend.position = "none",axis.text.x=element_text(angle=90,vjust=0.5, hjust=1))



#Fig 2 may be the same, but for the each positions-FG combination? Maybe heatmap (but we lose the SE's)

```


